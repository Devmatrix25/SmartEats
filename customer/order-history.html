<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order History - SmartEats</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="../src/base.css">
    
    <style>
        .history-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: none;
            transition: all 0.3s ease;
        }
        
        .history-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .order-item-preview {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .filter-btn {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            background: white;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }
        
        .filter-btn.active {
            background: var(--primary-orange);
            color: white;
            border-color: var(--primary-orange);
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }
        
        .empty-state-icon {
            font-size: 4rem;
            color: var(--light-grey);
            margin-bottom: 1rem;
        }
        
        .pagination .page-link {
            border: none;
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            margin: 0 0.25rem;
            border-radius: 8px;
        }
        
        .pagination .page-item.active .page-link {
            background: var(--primary-orange);
            color: white;
        }
    </style>
</head>
<body>
    <smart-eats-navbar role="customer"></smart-eats-navbar>

    <div class="container py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="fw-bold mb-1">Order History</h2>
                        <p class="text-muted mb-0">View your past orders and reorder favorites</p>
                    </div>
                    <div class="d-flex gap-2">
                        <a href="track-order.html" class="btn btn-outline-primary">
                            <i class="fas fa-truck me-2"></i>Track Order
                        </a>
                        <a href="restaurants.html" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>New Order
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex flex-wrap align-items-center">
                    <span class="me-3 fw-bold">Filter by:</span>
                    <button class="filter-btn active" onclick="filterOrders('all')">All Orders</button>
                    <button class="filter-btn" onclick="filterOrders('delivered')">Delivered</button>
                    <button class="filter-btn" onclick="filterOrders('preparing')">Preparing</button>
                    <button class="filter-btn" onclick="filterOrders('cancelled')">Cancelled</button>
                    
                    <div class="ms-auto">
                        <select class="form-select" id="sortSelect" onchange="sortOrders(this.value)">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="price_high">Highest Price</option>
                            <option value="price_low">Lowest Price</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders List -->
        <div id="ordersList">
            <!-- Orders will be loaded here -->
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-3">Loading your orders...</p>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-state-icon">
                <i class="fas fa-shopping-bag"></i>
            </div>
            <h4 class="text-muted mb-3">No orders yet</h4>
            <p class="text-muted mb-4">You haven't placed any orders yet. Start exploring restaurants and place your first order!</p>
            <a href="restaurants.html" class="btn btn-primary btn-lg">
                <i class="fas fa-utensils me-2"></i>Browse Restaurants
            </a>
        </div>

        <!-- Pagination -->
        <nav id="pagination" class="d-flex justify-content-center mt-4" style="display: none;">
            <!-- Pagination will be loaded here -->
        </nav>
    </div>

    <!-- Order Details Modal -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Order Details - <span id="modalOrderNumber"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="orderDetailsContent">
                        <!-- Order details will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="reorder()" id="reorderBtn">
                        <i class="fas fa-redo me-2"></i>Reorder
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="trackThisOrder()" id="trackBtn">
                        <i class="fas fa-truck me-2"></i>Track Order
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../src/base.js"></script>
    <script src="../src/components/navbar.js"></script>
    
    <script>
        let allOrders = [];
        let filteredOrders = [];
        let currentPage = 1;
        const ordersPerPage = 10;
        let currentFilter = 'all';
        let currentSort = 'newest';

        // Initialize order history
        async function initOrderHistory() {
            await loadOrders();
            setupEventListeners();
        }

        // Load orders from API
        async function loadOrders() {
            try {
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('ordersList').innerHTML = '';
                document.getElementById('pagination').style.display = 'none';

                const response = await smartEats.apiCall('/orders');
                if (response.ok) {
                    const data = await response.json();
                    allOrders = data.orders || [];
                    
                    if (allOrders.length === 0) {
                        showEmptyState();
                    } else {
                        applyFiltersAndSort();
                        displayOrders();
                        setupPagination();
                    }
                } else {
                    throw new Error('Failed to load orders');
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                // For demo, create mock orders
                createMockOrders();
            } finally {
                document.getElementById('loadingState').style.display = 'none';
            }
        }

        // Apply filters and sorting
        function applyFiltersAndSort() {
            // Filter
            if (currentFilter === 'all') {
                filteredOrders = [...allOrders];
            } else {
                filteredOrders = allOrders.filter(order => order.status === currentFilter);
            }

            // Sort
            switch (currentSort) {
                case 'newest':
                    filteredOrders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    break;
                case 'oldest':
                    filteredOrders.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                    break;
                case 'price_high':
                    filteredOrders.sort((a, b) => (b.totalAmount || 0) - (a.totalAmount || 0));
                    break;
                case 'price_low':
                    filteredOrders.sort((a, b) => (a.totalAmount || 0) - (b.totalAmount || 0));
                    break;
            }
        }

        // Display orders
        function displayOrders() {
            const startIndex = (currentPage - 1) * ordersPerPage;
            const endIndex = startIndex + ordersPerPage;
            const ordersToShow = filteredOrders.slice(startIndex, endIndex);

            const container = document.getElementById('ordersList');
            
            if (ordersToShow.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h4 class="text-muted mb-3">No orders found</h4>
                        <p class="text-muted mb-4">No orders match your current filter criteria.</p>
                        <button class="btn btn-outline-primary" onclick="filterOrders('all')">
                            Show All Orders
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = ordersToShow.map(order => `
                <div class="history-card" onclick="viewOrderDetails('${order._id}')" style="cursor: pointer;">
                    <div class="row align-items-center">
                        <div class="col-md-2">
                            <img src="${order.restaurant?.images?.[0] || 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?ixlib=rb-4.0.3&auto=format&fit=crop&w=100&q=80'}" 
                                 alt="${order.restaurant?.name}" 
                                 class="rounded" 
                                 width="80" 
                                 height="80">
                        </div>
                        <div class="col-md-3">
                            <h6 class="fw-bold mb-1">${order.restaurant?.name || 'Restaurant'}</h6>
                            <p class="text-muted small mb-1 order-item-preview">
                                ${getOrderItemsPreview(order.items)}
                            </p>
                            <p class="text-muted small mb-0">${formatDate(order.createdAt)}</p>
                        </div>
                        <div class="col-md-2">
                            <p class="fw-bold mb-1">₹${order.totalAmount?.toFixed(2) || '0.00'}</p>
                            <p class="text-muted small mb-0">${order.items?.length || 0} items</p>
                        </div>
                        <div class="col-md-3">
                            <span class="status-badge ${getStatusBadgeClass(order.status)}">
                                ${formatStatus(order.status)}
                            </span>
                            ${order.status === 'delivered' ? `
                                <div class="mt-1">
                                    ${generateStarRating(order.restaurantRating)}
                                </div>
                            ` : ''}
                        </div>
                        <div class="col-md-2 text-end">
                            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); viewOrderDetails('${order._id}')">
                                View Details
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Setup pagination
        function setupPagination() {
            const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
            
            if (totalPages <= 1) {
                document.getElementById('pagination').style.display = 'none';
                return;
            }

            document.getElementById('pagination').style.display = 'flex';
            
            let paginationHTML = `
                <ul class="pagination">
                    <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
            `;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    paginationHTML += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                        </li>
                    `;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            paginationHTML += `
                    <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            `;

            document.getElementById('pagination').innerHTML = paginationHTML;
        }

        // Change page
        function changePage(page) {
            currentPage = page;
            displayOrders();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Filter orders
        function filterOrders(filter) {
            currentFilter = filter;
            currentPage = 1;
            
            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            applyFiltersAndSort();
            displayOrders();
            setupPagination();
        }

        // Sort orders
        function sortOrders(sortBy) {
            currentSort = sortBy;
            applyFiltersAndSort();
            displayOrders();
        }

        // View order details
        async function viewOrderDetails(orderId) {
            try {
                const response = await smartEats.apiCall(`/orders/${orderId}`);
                if (response.ok) {
                    const order = await response.json();
                    showOrderDetailsModal(order);
                }
            } catch (error) {
                console.error('Error loading order details:', error);
                smartEats.showToast('Error loading order details', 'error');
            }
        }

        // Show order details modal
        function showOrderDetailsModal(order) {
            document.getElementById('modalOrderNumber').textContent = order.orderNumber;
            
            const content = document.getElementById('orderDetailsContent');
            content.innerHTML = `
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6>Restaurant Information</h6>
                        <p><strong>Name:</strong> ${order.restaurant?.name}</p>
                        <p><strong>Address:</strong> ${order.restaurant?.address}</p>
                        <p><strong>Phone:</strong> ${order.restaurant?.phone}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Order Information</h6>
                        <p><strong>Status:</strong> <span class="status-badge ${getStatusBadgeClass(order.status)}">${formatStatus(order.status)}</span></p>
                        <p><strong>Order Date:</strong> ${formatDateTime(order.createdAt)}</p>
                        <p><strong>Payment Method:</strong> ${order.paymentMethod}</p>
                        ${order.deliveredAt ? `<p><strong>Delivered:</strong> ${formatDateTime(order.deliveredAt)}</p>` : ''}
                    </div>
                </div>
                
                <h6>Delivery Address</h6>
                <p>${order.deliveryAddress?.address}<br>
                ${order.deliveryAddress?.city}, ${order.deliveryAddress?.pincode}</p>
                
                <hr>
                
                <h6>Order Items</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${order.items?.map(item => `
                                <tr>
                                    <td>
                                        <strong>${item.name}</strong>
                                        ${item.specialInstructions ? `<br><small class="text-muted">${item.specialInstructions}</small>` : ''}
                                    </td>
                                    <td>${item.quantity}</td>
                                    <td>₹${item.price?.toFixed(2)}</td>
                                    <td>₹${((item.price || 0) * (item.quantity || 1)).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div class="row">
                    <div class="col-md-6 offset-md-6">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Items Total:</span>
                            <span>₹${order.subtotal?.toFixed(2)}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Delivery Fee:</span>
                            <span>₹${order.deliveryFee?.toFixed(2)}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Taxes:</span>
                            <span>₹${order.tax?.toFixed(2)}</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between fw-bold">
                            <span>Total Amount:</span>
                            <span>₹${order.totalAmount?.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
                
                ${order.status === 'delivered' ? `
                    <hr>
                    <h6>Rating & Feedback</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Restaurant Rating:</strong> ${generateStarRating(order.restaurantRating)}</p>
                        </div>
                        ${order.driver ? `
                            <div class="col-md-6">
                                <p><strong>Driver Rating:</strong> ${generateStarRating(order.driverRating)}</p>
                            </div>
                        ` : ''}
                    </div>
                    ${order.feedback ? `<p><strong>Feedback:</strong> ${order.feedback}</p>` : ''}
                ` : ''}
            `;

            // Update action buttons
            const reorderBtn = document.getElementById('reorderBtn');
            const trackBtn = document.getElementById('trackBtn');
            
            reorderBtn.style.display = order.status === 'delivered' || order.status === 'cancelled' ? 'inline-block' : 'none';
            trackBtn.style.display = ['confirmed', 'preparing', 'ready', 'picked_up', 'on_the_way'].includes(order.status) ? 'inline-block' : 'none';

            const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
            modal.show();
        }

        // Reorder functionality
        function reorder() {
            smartEats.showToast('Adding items to cart...', 'info');
            // In production, this would add all items from the order to cart
            setTimeout(() => {
                window.location.href = 'cart.html';
            }, 1000);
        }

        // Track this order
        function trackThisOrder() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('orderDetailsModal'));
            modal.hide();
            window.location.href = `track-order.html?orderNumber=${document.getElementById('modalOrderNumber').textContent}`;
        }

        // Utility functions
        function getOrderItemsPreview(items) {
            if (!items || items.length === 0) return 'No items';
            const itemNames = items.map(item => item.name);
            return itemNames.join(', ');
        }

        function formatStatus(status) {
            const statusMap = {
                pending: 'Pending',
                confirmed: 'Confirmed',
                preparing: 'Preparing',
                ready: 'Ready',
                picked_up: 'Picked Up',
                on_the_way: 'On the Way',
                delivered: 'Delivered',
                cancelled: 'Cancelled'
            };
            return statusMap[status] || status;
        }

        function getStatusBadgeClass(status) {
            const classes = {
                pending: 'bg-warning',
                confirmed: 'bg-info',
                preparing: 'bg-primary',
                ready: 'bg-success',
                picked_up: 'bg-success',
                on_the_way: 'bg-success',
                delivered: 'bg-secondary',
                cancelled: 'bg-danger'
            };
            return classes[status] || 'bg-light text-dark';
        }

        function generateStarRating(rating) {
            if (!rating) return 'Not rated';
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                stars += `<i class="fas fa-star ${i <= rating ? 'text-warning' : 'text-light'}"></i>`;
            }
            return stars;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatDateTime(dateString) {
            return new Date(dateString).toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showEmptyState() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('ordersList').innerHTML = '';
            document.getElementById('pagination').style.display = 'none';
        }

        function setupEventListeners() {
            // Add any additional event listeners here
        }

        // Demo function - create mock orders
        function createMockOrders() {
            const mockOrders = [
                {
                    _id: '1',
                    orderNumber: 'SE123456789',
                    status: 'delivered',
                    restaurant: {
                        name: 'Pizza Palace',
                        images: ['https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?ixlib=rb-4.0.3&auto=format&fit=crop&w=100&q=80'],
                        address: '123 Food Street, City',
                        phone: '+911234567890'
                    },
                    items: [
                        { name: 'Margherita Pizza', price: 399, quantity: 1 },
                        { name: 'Garlic Bread', price: 149, quantity: 2 },
                        { name: 'Coke', price: 60, quantity: 1 }
                    ],
                    subtotal: 757,
                    deliveryFee: 30,
                    tax: 45.42,
                    totalAmount: 832.42,
                    paymentMethod: 'card',
                    restaurantRating: 4,
                    driverRating: 5,
                    feedback: 'Great service and delicious food!',
                    createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                    deliveredAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000 + 45 * 60 * 1000).toISOString(),
                    deliveryAddress: {
                        address: '456 Home Avenue, Apartment 21',
                        city: 'City',
                        pincode: '560001'
                    }
                },
                {
                    _id: '2',
                    orderNumber: 'SE987654321',
                    status: 'on_the_way',
                    restaurant: {
                        name: 'Burger Hub',
                        images: ['https://images.unsplash.com/photo-1572802419224-296b0aeee0d9?ixlib=rb-4.0.3&auto=format&fit=crop&w=100&q=80'],
                        address: '789 Burger Lane, City',
                        phone: '+911234567891'
                    },
                    items: [
                        { name: 'Classic Burger', price: 199, quantity: 2 },
                        { name: 'French Fries', price: 99, quantity: 1 },
                        { name: 'Chocolate Shake', price: 129, quantity: 1 }
                    ],
                    subtotal: 626,
                    deliveryFee: 25,
                    tax: 37.56,
                    totalAmount: 688.56,
                    paymentMethod: 'upi',
                    createdAt: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString(),
                    deliveryAddress: {
                        address: '456 Home Avenue, Apartment 21',
                        city: 'City',
                        pincode: '560001'
                    }
                }
            ];

            allOrders = mockOrders;
            applyFiltersAndSort();
            displayOrders();
            setupPagination();
            document.getElementById('loadingState').style.display = 'none';
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            initOrderHistory();
        });
    </script>
</body>
</html>